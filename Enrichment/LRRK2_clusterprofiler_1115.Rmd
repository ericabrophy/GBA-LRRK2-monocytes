---
title: "GO analysis: LRRK2 by Erica Brophy"
output: html_notebook
---

```{r message=FALSE, warning=FALSE}
# For data management
library(tidyverse)
library(clusterProfiler)
library(org.Hs.eg.db)
library(pheatmap)
library(DOSE)
library(enrichplot)
library(ggupset)
library(rrvgo)
```

```{r message=FALSE, warning=FALSE}
df1 <- read_tsv("/Users/ericabrophy/Documents/Allanalysis_results_121824_BioPD_Erica/SVA/GBAviPD_SVA_DEGs.tsv")
df1 <- df1 %>%
    mutate(ensembl =  sub("\\.[^.]*$", "", ensembl))
 df1 <- filter(df1, adj.P.Val < 0.05)
 names(df1)[8] <- "symbol"
 
df2 <- read_tsv("/Users/ericabrophy/Documents/Allanalysis_results_121824_BioPD_Erica/SVA/LRRK2viPD_SVA_DEGs.tsv")
 df2<- df2 %>%
     mutate(ensembl =  sub("\\.[^.]*$", "", ensembl))
 df2 <- filter(df2, adj.P.Val < 0.05)
 names(df2)[8] <- "symbol"
```
 
```{r}
 GBA_minus <- df1[!df1$ensembl %in% df2$ensembl,]
 LRRK2_minus <- df2[!df2$ensembl %in% df1$ensembl,]
```


```{r}
df <- read_tsv("/Users/ericabrophy/Documents/Allanalysis_results_121824_BioPD_Erica/SVA/LRRK2viPD_SVA_DEGs_minus.tsv")
df <- df %>%
    mutate(gene_ids =  sub("\\.[^.]*$", "", ensembl))
names(df)[8] <- "symbol"

#df <- df[df$symbol %in% sig_modules_14$symbol,]

# we want the log2 fold change 
original_gene_list <- df$logFC

# name the vector
names(original_gene_list) <- df$gene_ids

# omit any NA values 
gene_list<-na.omit(original_gene_list)

# sort the list in decreasing order (required for clusterProfiler)
gene_list = sort(gene_list, decreasing = TRUE)

head(gene_list)

df <- filter(df , adj.P.Val < 0.05)
```

```{r}
theme_paper <- function () { 
    theme_bw(base_size=7, base_family="Helvetica") %+replace% 
        theme(
          panel.grid = element_blank(),
          strip.background = element_blank(),
          #panel.border = element_blank(),
          axis.line = element_line(),
          axis.ticks = element_line(colour = "black"),
          #text = element_text(color = "black"), 
          strip.text = element_text(color = "black"),
          axis.text = element_text(colour = "black"),
            panel.background  = element_blank(),
            plot.background = element_rect(fill="white", colour=NA), 
            legend.background = element_rect(fill="transparent", colour=NA),
            legend.key = element_rect(fill="transparent", colour=NA), legend.text = element_text(size = 7), 
          legend.position = "right", legend.spacing.y  =  unit(0.001, 'cm')
        )
}
```



```{r}
# Use p-values to filter significant genes (e.g., p-value < 0.05)
df_sig <- df[df$adj.P.Val < 0.05, ]

# Perform GO enrichment analysis with significant genes
go_enrich <- enrichGO(
  gene = df_sig$symbol,             # Provide the Entrez gene IDs
  OrgDb = org.Hs.eg.db,                # Organism database (for human)
  keyType = "SYMBOL",                # Key type used for the input genes
  ont = "BP",                          # GO term ontology ("BP" for Biological Process, "MF" for Molecular Function, "CC" for Cellular Component)
  pAdjustMethod = "BH"                # Set q-value cutoff (you can change this threshold)
)

# View the GO enrichment results
summary(go_enrich)
go_df <- as.data.frame(go_enrich)

# Plot a dot plot of the GO enrichment
#dotplot(go_enrich, showCategory=10)  # Show top 10 enriched GO terms

# Alternatively, you can use a barplot for visualization
LRRK2_barplot <- barplot(go_enrich, showCategory = 10) +
  scale_fill_gradient(low = "#2166AC", high = "#B2182B") +  # Apply the color scale
  theme_paper()  # Apply custom theme

# Display the plot
print(LRRK2_barplot)
```
```{r}
Overlap_Collapse <- read_excel("Documents/Gene_sets/Collapsed_LRRK2minus_GOs.xlsx", 
    col_names = FALSE)
```

```{r}
library(clusterProfiler)

# Assuming you already have an enrichResult object, like:
# go_result <- enrichGO(gene = your_gene_list, OrgDb = org.Hs.eg.db, ont = "BP", pAdjustMethod = "BH")

# Step 1: Extract the result slot
result_df <- go_enrich@result

# Step 2: Filter the results by p-value (e.g., p < 0.05)
filtered_result <- result_df[result_df$ID %in% Overlap_Collapse$...1,]
# Step 3: Create a new enrichResult object with the filtered results
go_enrich_filtered <- new(
  "enrichResult",
  result = filtered_result,
  pvalueCutoff = 0.05,
  pAdjustMethod = "BH",
  qvalueCutoff = 0.05,
  organism = go_enrich@organism,
  ontology = go_enrich@ontology,
  keytype = go_enrich@keytype,
  gene = go_enrich@gene,
  universe = go_enrich@universe,
  geneSets = go_enrich@geneSets,
  readable = go_enrich@readable
)

# Step 4: Verify the new enrichResult object
print(go_enrich_filtered)

# Now you can visualize or further analyze the filtered object
dotplot(go_enrich_filtered)
cnetplot(go_enrich_filtered)


result_df <- go_enrich_filtered@result

# Step 2: Use gsub to replace the text in the Description column
result_df$Description <- gsub("regulation of canonical NF-kappaB signal transduction", 
                               "regulation of NF-ÎºB signaling", 
                               result_df$Description)

# Step 3: Update the enrichResult object with the modified result
go_enrich_filtered@result <- result_df

# Check if the modification was successful
head(go_enrich_filtered@result)

```


```{r message=TRUE, warning=FALSE}
edox2 <- pairwise_termsim(go_enrich_filtered)


# Assuming 'edox2' is your object for pairwise similarity or GO enrichment analysis
p2 <- treeplot(edox2, hclust_method = "average")  # Set to a valid number (e.g., 1 or 2)



# If you still want to apply coloring
p2 <- p2 + scale_color_gradient(low = "#2166AC", high = "#B2182B")
p2
```

```{r}
ggsave(plot = p2, filename = "/Users/ericabrophy/Documents/tree_LRRK2unique.pdf", width = 8.5, height = 6, units = "in")
```

```{r}
# Separate upregulated and downregulated genes based on logFC
df_up <- df_sig[df_sig$logFC > 0, ]   # Upregulated genes
df_down <- df_sig[df_sig$logFC < 0, ] # Downregulated genes
```

```{r}
# GO enrichment for upregulated genes
go_up <- enrichGO(
  gene = df_up$symbol, 
  OrgDb = org.Hs.eg.db, 
  keyType = "SYMBOL", 
  ont = "BP", 
  pAdjustMethod = "BH", 
  qvalueCutoff = 0.05
)

# GO enrichment for downregulated genes
go_down <- enrichGO(
  gene = df_down$symbol, 
  OrgDb = org.Hs.eg.db, 
  keyType = "SYMBOL", 
  ont = "BP", 
  pAdjustMethod = "BH", 
  qvalueCutoff = 0.05
)

```

```{r}
barplot(go_down, showCategory=10) + theme_paper()

up <- dotplot(go_up, showCategory = 10) + ggtitle("GO Enrichment for Upregulated Genes") +theme_paper()
up
down <- dotplot(go_down, showCategory = 10) + ggtitle("GO Enrichment for Downregulated Genes") + theme_paper()
down
```

```{r}
#ggsave(plot = up, filename = "/Users/ericabrophy/Documents/Allanalysis_results_121824_BioPD_Erica/Enrichment/LRRK2_enrich_up.pdf", width = 5, height = 6, units = "in")
#ggsave(plot = down, filename = "/Users/ericabrophy/Documents/Allanalysis_results_121824_BioPD_Erica/Enrichment/LRRK2_enrich_down.pdf", width = 5, height = 6, units = "in")
```

```{r}
library(patchwork)

# Combine the upregulated and downregulated GO enrichment plots
combined_plot <- up / down  # "/" stacks them vertically, use "|" for side-by-side

# Display the combined p
combined_plot

#ggsave(plot = combined_plot, filename = "/Users/ericabrophy/Documents/Allanalysis_results_121824_BioPD_Erica/Enrichment/LRRK2_enrich_combined.pdf", width = 5, height = 6, units = "in")
```


```{r}
go_up <- as.data.frame(go_up)
go_up$gene_reg <- "up"
go_up$group <- "LRRK2_PD"
go_down <- as.data.frame(go_down)
go_down$gene_reg <- "down"
go_down$group <- "LRRK2_PD"

LRRK2_go <- rbind(go_up, go_down)
#write_tsv(LRRK2_go, "/Users/ericabrophy/Documents/Allanalysis_results_121824_BioPD_Erica/Enrichment/LRRK2_go.tsv")
```






